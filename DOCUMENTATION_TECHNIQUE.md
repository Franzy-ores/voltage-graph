# Documentation Technique - Calculateur de Chute de Tension

## Vue d'ensemble

Cette application permet de calculer les chutes de tension dans un rÃ©seau Ã©lectrique en crÃ©ant visuellement des nÅ“uds et des cÃ¢bles sur une carte interactive, puis en gÃ©nÃ©rant des rapports PDF dÃ©taillÃ©s.

## Architecture

### Technologies utilisÃ©es
- **Frontend**: React 18 + TypeScript + Vite
- **UI**: Tailwind CSS + shadcn/ui components
- **Cartographie**: Leaflet + OpenStreetMap
- **Ã‰tat global**: Zustand
- **PDF**: jsPDF + html2canvas
- **Calculs**: Classes TypeScript personnalisÃ©es

### Structure des dossiers
```
src/
â”œâ”€â”€ components/           # Composants React
â”‚   â”œâ”€â”€ ui/              # Composants UI rÃ©utilisables (shadcn)
â”‚   â”œâ”€â”€ MapView.tsx      # Carte interactive principale
â”‚   â”œâ”€â”€ ResultsPanel.tsx # Panneau des rÃ©sultats
â”‚   â”œâ”€â”€ EditPanel.tsx    # Panneau d'Ã©dition nÅ“uds/cÃ¢bles
â”‚   â””â”€â”€ ...
â”œâ”€â”€ store/               # Gestion d'Ã©tat Zustand
â”‚   â””â”€â”€ networkStore.ts  # Store principal du rÃ©seau
â”œâ”€â”€ types/               # DÃ©finitions TypeScript
â”‚   â””â”€â”€ network.ts       # Types du rÃ©seau Ã©lectrique
â”œâ”€â”€ utils/               # Utilitaires
â”‚   â”œâ”€â”€ electricalCalculations.ts  # Moteur de calcul
â”‚   â”œâ”€â”€ pdfGenerator.ts            # GÃ©nÃ©rateur PDF
â”‚   â””â”€â”€ tableGenerator.ts          # GÃ©nÃ©rateur tableaux
â”œâ”€â”€ data/                # DonnÃ©es par dÃ©faut
â”‚   â””â”€â”€ defaultCableTypes.ts       # Types de cÃ¢bles
â””â”€â”€ pages/               # Pages principales
    â””â”€â”€ Index.tsx        # Page principale
```

## ModÃ¨le de donnÃ©es

### Types principaux (`src/types/network.ts`)

```typescript
// SystÃ¨me de tension
type VoltageSystem = 'TRIPHASÃ‰_230V' | 'TÃ‰TRAPHASÃ‰_400V';

// Types de connexion
type ConnectionType = 'MONO_230V_PN' | 'MONO_230V_PP' | 'TRI_230V_3F' | 'TÃ‰TRA_3P+N_230_400V';

// ScÃ©narios de calcul
type CalculationScenario = 'PRÃ‰LÃˆVEMENT' | 'MIXTE' | 'PRODUCTION';

// NÅ“ud du rÃ©seau
interface Node {
  id: string;
  name: string;
  lat: number;
  lng: number;
  isSource: boolean;
  connectionType: ConnectionType;
  tensionCible?: number;
  clients: ClientCharge[];      // Charges connectÃ©es
  productions: ProductionPV[];  // Productions PV connectÃ©es
}

// CÃ¢ble du rÃ©seau
interface Cable {
  id: string;
  name: string;
  nodeAId: string;
  nodeBId: string;
  typeId: string;
  coordinates: { lat: number; lng: number }[];
  // PropriÃ©tÃ©s calculÃ©es
  length_m?: number;
  current_A?: number;
  voltageDrop_V?: number;
  voltageDropPercent?: number;
  losses_kW?: number;
}

// Type de cÃ¢ble avec propriÃ©tÃ©s Ã©lectriques
interface CableType {
  id: string;
  label: string;
  R12_ohm_per_km: number;   // RÃ©sistance phase-phase
  X12_ohm_per_km: number;   // RÃ©actance phase-phase
  R0_ohm_per_km: number;    // RÃ©sistance phase-neutre
  X0_ohm_per_km: number;    // RÃ©actance phase-neutre
  I_max_A: number;          // Courant admissible
  poses: string[];          // Modes de pose autorisÃ©s
}

// Projet complet
interface Project {
  id: string;
  name: string;
  voltageSystem: VoltageSystem;
  cosPhi: number;
  foisonnementCharges: number;
  foisonnementProductions: number;
  nodes: Node[];
  cables: Cable[];
  cableTypes: CableType[];
  geographicBounds?: any;
}
```

## Moteur de calcul Ã©lectrique

### Classe `ElectricalCalculator` (`src/utils/electricalCalculations.ts`)

Cette classe implÃ©mente les calculs selon les normes Ã©lectriques franÃ§aises :

#### MÃ©thodes principales

```typescript
class ElectricalCalculator {
  // Calcule un scÃ©nario complet
  calculateScenario(
    nodes: Node[],
    cables: Cable[],
    cableTypes: CableType[],
    scenario: CalculationScenario,
    foisonnementCharges: number = 100,
    foisonnementProductions: number = 100
  ): CalculationResult

  // Calcule la distance gÃ©odÃ©sique entre deux points
  static calculateGeodeticDistance(
    lat1: number, lon1: number, 
    lat2: number, lon2: number
  ): number

  // Calcule la longueur d'un cÃ¢ble Ã  partir de ses coordonnÃ©es
  static calculateCableLength(
    coordinates: { lat: number; lng: number }[]
  ): number
}
```

#### Algorithme de calcul

1. **Construction de l'arbre** : CrÃ©ation d'un arbre enracinÃ© depuis la source
2. **Calcul des puissances Ã©quivalentes** : Application des scÃ©narios et foisonnements
3. **Calcul des puissances aval** : Somme des charges en aval de chaque cÃ¢ble
4. **Calcul des courants** : `I = S / (U * cos Ï† * âˆš3)` (triphasÃ©) ou `I = S / (U * cos Ï†)` (monophasÃ©)
5. **Calcul des chutes de tension** : `Î”U = I * L * (R * cos Ï† + X * sin Ï†)`
6. **Cumul des chutes** : Propagation depuis la source vers les extrÃ©mitÃ©s
7. **VÃ©rification EN50160** : ContrÃ´le des seuils Â±8% et Â±10%

### Formules utilisÃ©es

```typescript
// Courant (triphasÃ©)
I_A = (S_kVA * 1000) / (âˆš3 * U_base * cos_Ï†)

// Courant (monophasÃ©)  
I_A = (S_kVA * 1000) / (U_base * cos_Ï†)

// Chute de tension
Î”U_V = I_A * L_km * (R_ohm_per_km * cos_Ï† + X_ohm_per_km * sin_Ï†) * âˆš3

// Pourcentage de chute
Î”U_percent = (Î”U_V / U_base) * 100

// Pertes Joule
P_losses_kW = I_AÂ² * R_total_ohm / 1000
```

## Gestion d'Ã©tat (Zustand)

### Store principal (`src/store/networkStore.ts`)

```typescript
interface NetworkState {
  // Projet actuel
  currentProject: Project | null;
  
  // Interface utilisateur
  selectedTool: 'select' | 'addNode' | 'addCable' | 'move';
  selectedNodeId: string | null;
  selectedCableId: string | null;
  selectedCableType: string;
  showVoltages: boolean;
  
  // Calculs
  calculationResults: Record<CalculationScenario, CalculationResult | null>;
  selectedScenario: CalculationScenario;
  
  // Actions
  addNode: (lat: number, lng: number, connectionType: ConnectionType) => void;
  addCable: (nodeAId: string, nodeBId: string, typeId: string, coordinates: any[]) => void;
  updateNode: (nodeId: string, updates: Partial<Node>) => void;
  deleteNode: (nodeId: string) => void;
  deleteCable: (cableId: string) => void;
  calculateNetwork: () => void;
  // ... autres actions
}
```

### Gestion des calculs

Les calculs sont dÃ©clenchÃ©s automatiquement lors des modifications du rÃ©seau :

```typescript
const calculateNetwork = () => {
  if (!currentProject) return;
  
  const calculator = new ElectricalCalculator(currentProject.cosPhi);
  const scenarios: CalculationScenario[] = ['PRÃ‰LÃˆVEMENT', 'MIXTE', 'PRODUCTION'];
  
  scenarios.forEach(scenario => {
    const result = calculator.calculateScenario(
      currentProject.nodes,
      currentProject.cables,
      currentProject.cableTypes,
      scenario,
      currentProject.foisonnementCharges,
      currentProject.foisonnementProductions
    );
    calculationResults[scenario] = result;
  });
};
```

## Interface cartographique

### Composant `MapView` (`src/components/MapView.tsx`)

#### FonctionnalitÃ©s principales

1. **Affichage des nÅ“uds** avec codes couleur selon le type :
   - ðŸ”µ Bleu : Charges seules
   - ðŸŸ¢ Vert : Productions seules  
   - ðŸŸ¡ Jaune : Mixte (charges + productions)
   - ðŸ”´ Rouge : Non-conformitÃ© EN50160
   - ðŸŸ¦ Cyan : Source 230V
   - ðŸŸ£ Magenta : Source 400V

2. **TracÃ© de cÃ¢bles interactif** :
   - Clic sur nÅ“ud source â†’ mode routage activÃ©
   - Clics intermÃ©diaires â†’ points du tracÃ©
   - Double-clic ou EntrÃ©e â†’ finalisation
   - Ã‰chap â†’ annulation

3. **Affichage des tensions** (optionnel) :
   - Tension calculÃ©e en temps rÃ©el
   - Charges et productions par nÅ“ud

#### Gestion des Ã©vÃ©nements

```typescript
// Clic sur la carte
const handleMapClick = (e: L.LeafletMouseEvent) => {
  if (selectedTool === 'addNode' && !routingActive) {
    addNode(e.latlng.lat, e.latlng.lng, 'MONO_230V_PN');
  } else if (routingActive) {
    // Ajouter point intermÃ©diaire au tracÃ©
    routingPointsRef.current = [...routingPointsRef.current, { 
      lat: e.latlng.lat, 
      lng: e.latlng.lng 
    }];
  }
};

// Double-clic : finaliser le routage
const handleMapDoubleClick = (e: L.LeafletMouseEvent) => {
  if (routingActive && routingFromNode) {
    const finalCoords = [...routingPointsRef.current, { 
      lat: e.latlng.lat, 
      lng: e.latlng.lng 
    }];
    addCable(routingFromNode, targetNodeId, selectedCableType, finalCoords);
  }
};
```

## GÃ©nÃ©ration de rapports PDF

### Classe `PDFGenerator` (`src/utils/pdfGenerator.ts`)

#### Structure du rapport

1. **Page de titre** avec date/heure
2. **RÃ©sumÃ© global** : charges, productions, pertes, conformitÃ©
3. **Comparaison des scÃ©narios** : tableau comparatif
4. **DÃ©tails par tronÃ§on** : tableau complet avec :
   - Tensions dÃ©part/arrivÃ©e de chaque cÃ¢ble
   - Courants, chutes de tension, pertes
   - Charges contractuelles/foisonnÃ©es et productions

#### MÃ©thodes principales

```typescript
class PDFGenerator {
  // GÃ©nÃ¨re le rapport complet
  async generateReport(data: PDFData): Promise<void>
  
  // Ajoute le rÃ©sumÃ© global
  private addGlobalSummary(data: PDFData): void
  
  // Ajoute la comparaison des scÃ©narios  
  private addScenarioComparison(data: PDFData): void
  
  // Ajoute le tableau dÃ©taillÃ© (avec capture HTML->image)
  private async addCableDetails(data: PDFData): Promise<void>
}
```

#### GÃ©nÃ©ration du tableau dÃ©taillÃ©

Le tableau est gÃ©nÃ©rÃ© en HTML puis capturÃ© en image pour prÃ©server la mise en forme :

```typescript
// GÃ©nÃ©rer le HTML du tableau
const tableHTML = generateCableDetailsTable(currentResult, data.project);

// CrÃ©er un Ã©lÃ©ment temporaire
const tempDiv = document.createElement('div');
tempDiv.innerHTML = tableHTML;
document.body.appendChild(tempDiv);

// Capturer en image
const canvas = await html2canvas(tempDiv, {
  scale: 2,
  backgroundColor: '#ffffff',
  useCORS: true
});

// Ajouter au PDF
const imgData = canvas.toDataURL('image/png', 1.0);
this.pdf.addImage(imgData, 'PNG', this.margin, this.currentY, imgWidth, imgHeight);
```

## ExtensibilitÃ©

### Ajouter un nouveau type de cÃ¢ble

1. **Ã‰diter** `src/data/defaultCableTypes.ts`
2. **Ajouter** les caractÃ©ristiques Ã©lectriques :

```typescript
{
  id: "nouveau_cable",
  label: "Nouveau cÃ¢ble XYZ",
  R12_ohm_per_km: 0.xxx,  // RÃ©sistance Î©/km
  X12_ohm_per_km: 0.xxx,  // RÃ©actance Î©/km  
  R0_ohm_per_km: 0.xxx,   // RÃ©sistance neutre Î©/km
  X0_ohm_per_km: 0.xxx,   // RÃ©actance neutre Î©/km
  I_max_A: xxx,           // Courant admissible A
  poses: ["ENTERRÃ‰", "AÃ‰RIEN", "SOUS_GAINE"]
}
```

### Ajouter un nouveau scÃ©nario de calcul

1. **Ã‰tendre** le type `CalculationScenario` dans `src/types/network.ts`
2. **Modifier** la logique dans `ElectricalCalculator.calculateScenario()`
3. **Mettre Ã  jour** l'interface dans `ResultsPanel.tsx`

### Personnaliser les calculs

La classe `ElectricalCalculator` peut Ãªtre Ã©tendue pour :
- Ajouter de nouveaux types de connexion
- Modifier les formules de chute de tension  
- ImplÃ©menter d'autres normes (IEC, NEC, etc.)

## DÃ©ploiement

### Variables d'environnement

Aucune variable d'environnement n'est requise pour le fonctionnement de base.

### Build de production

```bash
npm run build    # GÃ©nÃ¨re le build optimisÃ© dans dist/
npm run preview  # PrÃ©visualise le build de production
```

### HÃ©bergement

L'application est une SPA (Single Page Application) qui peut Ãªtre hÃ©bergÃ©e sur :
- Vercel, Netlify (recommandÃ©)  
- GitHub Pages
- Tout serveur web statique

## Maintenance et debugging

### Console de debug

L'application affiche des logs dÃ©taillÃ©s dans la console du navigateur :

```typescript
// Exemple de logs de calcul
console.log('=== CALCUL Ã‰LECTRIQUE ===');
console.log('ScÃ©nario:', scenario);
console.log('NÅ“uds:', nodes.length);
console.log('CÃ¢bles:', cables.length);
console.log('RÃ©sultat:', result);
```

### Points d'attention

1. **Performance** : Les calculs sont synchrones, limitez Ã  ~50 nÅ“uds
2. **PrÃ©cision** : Les coordonnÃ©es GPS sont arrondies Ã  6 dÃ©cimales
3. **Navigateur** : Requiert un navigateur moderne (ES2020+)
4. **MÃ©moire** : Les projets sont stockÃ©s dans localStorage (limite ~5MB)

### RÃ©solution des problÃ¨mes courants

| ProblÃ¨me | Cause | Solution |
|----------|-------|----------|
| Calculs incorrects | Mauvais paramÃ¨tres cÃ¢ble | VÃ©rifier R, X, I_max |
| PDF lent | Tableau trop large | RÃ©duire nombre colonnes |
| Carte non affichÃ©e | ProblÃ¨me Leaflet | VÃ©rifier console rÃ©seau |
| Projet non sauvÃ© | localStorage plein | Nettoyer les anciens projets |

## Roadmap

### AmÃ©liorations prÃ©vues

- [ ] Import/export de projets (.json)
- [ ] Calculs de court-circuit
- [ ] Support des transformateurs  
- [ ] API REST pour calculs serveur
- [ ] Mode multi-utilisateurs
- [ ] Historique des modifications (Git-like)

---

## Contacts

Pour questions techniques ou contributions :
- VÃ©rifier la console navigateur pour les erreurs
- Utiliser l'historique Lovable pour revenir Ã  une version stable
- Consulter la documentation des dÃ©pendances (Leaflet, jsPDF, etc.)